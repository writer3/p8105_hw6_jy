---
title: "HW 6"
output: github_document
---

```{r}
library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


Load key packages

```{r}
library(p8105.datasets)
library(modelr)
library(purrr)
```

## Problem 2

Creating a `city_state` variable (e.g. “Baltimore, MD”), and a binary variable called `resolution` indicating whether the homicide is solved. Omitting cities Dallas, TX; Phoenix, AZ; and Kansas City, MO as these don’t report victim race. Also omiting Tulsa, AL as this is a data entry mistake. For this problem, limiting the analysis those for whom victim_race is white or black. Ensuring that victim_age is numeric.

```{r}
homicide_df = 
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) |> 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Open/No arrest" ~ 0,
      disposition == "Closed without arrest" ~ 0,
      disposition == "Closed by arrest" ~ 1)
    ) |> 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) |> filter(victim_race %in% c("White", "Black"))
```


For Baltimore, MD, using the `glm` function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors. Saving the output of `glm` as an R object; applying the `broom::tidy` to this object; and obtaining the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing male victims to female victims keeping all other variables fixed.

```{r}
balt_glm =
  homicide_df |> 
  filter(city_state == "Baltimore, MD") |> 
  glm(resolution ~ victim_age + victim_sex + victim_race, family = binomial(), data = _)

balt_glm |> 
  broom::tidy() |> 
  mutate(
    OR = exp(estimate),
    OR_CI_upper = exp(estimate + 1.96 * std.error), 
    OR_CI_lower = exp(estimate - 1.96 * std.error)
  ) |> 
  filter(term == "victim_sexMale") |> 
  knitr::kable(digits = 3)
```


Running `glm` for each of the cities in the dataset, and extracting the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims. Doing this within a “tidy” pipeline, making use of `purrr::map`, list columns, and unnesting as necessary to create a dataframe with estimated ORs and CIs for each city.

```{r}
mod_results =
  homicide_df |> 
  nest(data = -city_state) |> 
  mutate(
    mods = map(data, \(df) glm(resolution ~ victim_age + victim_sex + victim_race,
                                 family = binomial(), data = df)),
    tidy_mods = map(mods, broom::tidy)) |> 
  select(-mods, -data) |> 
  unnest(cols = tidy_mods) |> 
  mutate(
    OR = exp(estimate),
    OR_CI_upper = exp(estimate + 1.96 * std.error), 
    OR_CI_lower = exp(estimate - 1.96 * std.error)
  ) |> 
  filter(term == "victim_sexMale")

mod_results |> 
  slice(1:3)|> 
  knitr::kable(digits = 3)
```

